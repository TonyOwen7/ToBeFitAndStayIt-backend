<!-- settings.component.html -->
<div class="app-container">
    <app-header></app-header>

    
    <main class="main-content">
     <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p style="color: rgba(104, 159, 56, 0.9)">Loading your profile...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="showError && !isLoading" class="message error-message">
      <div class="message-icon">✕</div>
      <div class="message-text">{{ errorMessage }}</div>
    </div>

    <!-- Success Message -->
    <div *ngIf="showSuccess && !isLoading" class="message success-message">
      <div class="message-icon">✓</div>
      <div class="message-text">{{ successMessage }}</div>
    </div>
  
      <!-- User Profile Section -->
      <div *ngIf="user && !isLoading" class="settings-container">
        <div class="settings-header">
          <h1 class="settings-title">Account Settings</h1>
          <p class="settings-subtitle">Manage your profile and wellness preferences</p>
        </div>
  
        <!-- Profile Overview Card -->
        <div class="profile-overview-card">
          <div class="profile-header">
            <div class="profile-avatar">
              <div class="avatar-circle">
                {{ (user.first_name?.[0] || user.username?.[0] || 'U').toUpperCase() }}
              </div>
            </div>
            <div class="profile-info">
              <h2 class="profile-name">{{ user.full_name || user.username }}</h2>
              <p class="profile-email">{{ user.email }}</p>
              <p class="profile-joined">Member since {{ user.date_joined | date:'mediumDate' }}</p>
            </div>
          </div>
  
          <!-- Health Metrics -->
          <div class="health-metrics" *ngIf="user.bmi || user.bmr || user.tdee">
            <div class="metric-item" *ngIf="user.bmi">
              <div class="metric-label">BMI</div>
              <div class="metric-value" [style.color]="getBMIColor(user.bmi)">
                {{ user.bmi }}
              </div>
              <div class="metric-category" [style.color]="getBMIColor(user.bmi)">
                {{ getBMICategory(user.bmi) }}
              </div>
            </div>
            <div class="metric-item" *ngIf="user.bmr">
              <div class="metric-label">BMR</div>
              <div class="metric-value">{{ user.bmr }}</div>
              <div class="metric-unit">cal/day</div>
            </div>
            <div class="metric-item" *ngIf="user.tdee">
              <div class="metric-label">TDEE</div>
              <div class="metric-value">{{ user.tdee }}</div>
              <div class="metric-unit">cal/day</div>
            </div>
          </div>
        </div>
  
        <!-- Profile Details Section -->
        <div class="profile-details-card">
          <div class="card-header">
            <h3 class="card-title">Profile Information</h3>
            <button 
              *ngIf="!isEditing" 
              class="edit-btn" 
              (click)="startEditing()"
              [disabled]="isLoading">
              <span class="btn-icon">✏️</span>
              Edit Profile
            </button>
          </div>
  
          <!-- View Mode -->
          <div *ngIf="!isEditing" class="profile-details-view">
            <div class="detail-grid">
              <div class="detail-item">
                <label class="detail-label">First Name</label>
                <div class="detail-value">{{ user.first_name || 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Last Name</label>
                <div class="detail-value">{{ user.last_name || 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Email</label>
                <div class="detail-value">{{ user.email }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Age</label>
                <div class="detail-value">{{ user.age || 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Gender</label>
                <div class="detail-value">{{ user.gender ? getGenderLabel(user.gender) : 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Weight</label>
                <div class="detail-value">{{ user.weight ? user.weight + ' kg' : 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Height</label>
                <div class="detail-value">{{ user.height ? user.height + ' cm' : 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Activity Level</label>
                <div class="detail-value">{{ user.activity_level ? getActivityLevelLabel(user.activity_level) : 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Health Goal</label>
                <div class="detail-value">{{ user.health_goal ? getHealthGoalLabel(user.health_goal) : 'Not provided' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Newsletter</label>
                <div class="detail-value">
                  <span class="newsletter-status" [class.subscribed]="user.wants_newsletter">
                    {{ user.wants_newsletter ? '✓ Subscribed' : '✕ Not subscribed' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
  
          <!-- Edit Mode -->
          <form *ngIf="isEditing" class="profile-edit-form" (ngSubmit)="saveProfile()">
            <div class="form-grid">
              <div class="form-group">
                <label for="firstName" class="form-label">First Name</label>
                <input 
                  type="text" 
                  id="firstName"
                  [(ngModel)]="editForm.first_name"
                  name="firstName"
                  class="form-input"
                  placeholder="Enter your first name">
              </div>
  
              <div class="form-group">
                <label for="lastName" class="form-label">Last Name</label>
                <input 
                  type="text" 
                  id="lastName"
                  [(ngModel)]="editForm.last_name"
                  name="lastName"
                  class="form-input"
                  placeholder="Enter your last name">
              </div>
  
              <div class="form-group">
                <label for="email" class="form-label">Email *</label>
                <input 
                  type="email" 
                  id="email"
                  [(ngModel)]="editForm.email"
                  name="email"
                  class="form-input"
                  placeholder="Enter your email"
                  required>
              </div>
  
              <div class="form-group">
                <label for="age" class="form-label">Age</label>
                <input 
                  type="number" 
                  id="age"
                  [(ngModel)]="editForm.age"
                  name="age"
                  class="form-input"
                  placeholder="Enter your age"
                  min="13"
                  max="120">
              </div>
  
              <div class="form-group">
                <label for="gender" class="form-label">Gender</label>
                <select 
                  id="gender"
                  [(ngModel)]="editForm.gender"
                  name="gender"
                  class="form-select">
                  <option value="" disabled>Select your gender</option>
                  <option *ngFor="let option of genderOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>
  
              <div class="form-group">
                <label for="weight" class="form-label">Weight (kg)</label>
                <input 
                  type="number" 
                  id="weight"
                  [(ngModel)]="editForm.weight"
                  name="weight"
                  class="form-input"
                  placeholder="Enter your weight"
                  min="30"
                  max="300"
                  step="0.1">
              </div>
  
              <div class="form-group">
                <label for="height" class="form-label">Height (cm)</label>
                <input 
                  type="number" 
                  id="height"
                  [(ngModel)]="editForm.height"
                  name="height"
                  class="form-input"
                  placeholder="Enter your height"
                  min="100"
                  max="250">
              </div>
  
              <div class="form-group">
                <label for="activityLevel" class="form-label">Activity Level</label>
                <select 
                  id="activityLevel"
                  [(ngModel)]="editForm.activity_level"
                  name="activityLevel"
                  class="form-select">
                  <option value="" disabled>Select your activity level</option>
                  <option *ngFor="let option of activityLevelOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>
  
              <div class="form-group">
                <label for="healthGoal" class="form-label">Health Goal</label>
                <select 
                  id="healthGoal"
                  [(ngModel)]="editForm.health_goal"
                  name="healthGoal"
                  class="form-select">
                  <option value="" disabled>Select your health goal</option>
                  <option *ngFor="let option of healthGoalOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>
  
              <div class="form-group full-width">
                <div class="checkbox-wrapper">
                  <input 
                    type="checkbox" 
                    id="newsletter"
                    [(ngModel)]="editForm.wants_newsletter"
                    name="newsletter"
                    class="form-checkbox">
                  <label for="newsletter" class="checkbox-label">
                    <span class="checkbox-icon"></span>
                    Subscribe to our wellness newsletter for tips and updates
                  </label>
                </div>
              </div>
            </div>
  
            <!-- Form Actions -->
            <div class="form-actions">
              <button 
                type="button" 
                class="btn btn-secondary" 
                (click)="cancelEditing()"
                [disabled]="isLoading">
                Cancel
              </button>
              <button 
                type="submit" 
                class="btn btn-primary" 
                [disabled]="isLoading">
                <span *ngIf="isLoading" class="btn-spinner"></span>
                {{ isLoading ? 'Saving...' : 'Save Changes' }}
              </button>
            </div>
          </form>
        </div>
  
        <!-- Additional Settings Section -->
        <div class="additional-settings-card">
          <div class="card-header">
            <h3 class="card-title">Account Actions</h3>
          </div>
          <div class="settings-actions">
            <button class="action-btn change-password-btn" (click)="openChangePasswordDialog()">
              <span class="btn-icon">🔐</span>
              Change Password
            </button>
            <button class="action-btn export-data-btn" (click)="exportUserData()">
              <span class="btn-icon">📊</span>
              Export My Data
            </button>
            <button class="action-btn delete-account-btn" (click)="openDeleteAccountDialog()">
              <span class="btn-icon">⚠️</span>
              Delete Account
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Change Password Modal -->
  <div *ngIf="showChangePasswordModal" class="modal-overlay" (click)="closeChangePasswordDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Change Password</h3>
        <button class="modal-close" (click)="closeChangePasswordDialog()">✕</button>
      </div>
      <form class="modal-form" (ngSubmit)="changePassword()">
        <div class="form-group">
          <label for="currentPassword" class="form-label">Current Password *</label>
          <input 
            type="password" 
            id="currentPassword"
            [(ngModel)]="passwordForm.current_password"
            name="currentPassword"
            class="form-input"
            placeholder="Enter your current password"
            required>
        </div>
        <div class="form-group">
          <label for="newPassword" class="form-label">New Password *</label>
          <input 
            type="password" 
            id="newPassword"
            [(ngModel)]="passwordForm.new_password"
            name="newPassword"
            class="form-input"
            placeholder="Enter your new password"
            minlength="8"
            required>
        </div>
        <div class="form-group">
          <label for="confirmPassword" class="form-label">Confirm New Password *</label>
          <input 
            type="password" 
            id="confirmPassword"
            [(ngModel)]="passwordForm.confirm_password"
            name="confirmPassword"
            class="form-input"
            placeholder="Confirm your new password"
            required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeChangePasswordDialog()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="isLoading">
            {{ isLoading ? 'Changing...' : 'Change Password' }}
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Delete Account Confirmation Modal -->
  <div *ngIf="showDeleteAccountModal" class="modal-overlay" (click)="closeDeleteAccountDialog()">
    <div class="modal-content danger-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Delete Account</h3>
        <button class="modal-close" (click)="closeDeleteAccountDialog()">✕</button>
      </div>
      <div class="modal-body">
        <div class="warning-message">
          <div class="warning-icon">⚠️</div>
          <div class="warning-text">
            <p><strong>This action cannot be undone!</strong></p>
            <p>Deleting your account will permanently remove all your data, including:</p>
            <ul>
              <li>Profile information</li>
              <li>Health metrics and tracking data</li>
              <li>Meal plans and nutrition logs</li>
              <li>Workout history</li>
              <li>All personal preferences</li>
            </ul>
          </div>
        </div>
        <form class="confirmation-form" (ngSubmit)="deleteAccount()">
          <div class="form-group">
            <label for="deleteConfirmation" class="form-label">
              Type "DELETE" to confirm account deletion *
            </label>
            <input 
              type="text" 
              id="deleteConfirmation"
              [(ngModel)]="deleteConfirmationText"
              name="deleteConfirmation"
              class="form-input"
              placeholder="Type DELETE here"
              required>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeDeleteAccountDialog()">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn btn-danger" 
              [disabled]="deleteConfirmationText !== 'DELETE' || isLoading">
              {{ isLoading ? 'Deleting...' : 'Delete Account' }}
            </button>
          </div>
        </form>
      </div>
    </div>
    <app-footer></app-footer>

  </div>